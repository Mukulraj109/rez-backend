# Agent 6: Notification System Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND CLIENT                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  React Native / Web App                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ HTTP API   â”‚  â”‚ Socket.IO  â”‚  â”‚ Notification UI    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ Calls      â”‚  â”‚ Connection â”‚  â”‚ Components         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                â”‚
             â”‚ REST API       â”‚ WebSocket
             â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND SERVER                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Express.js Server                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              Authentication Middleware               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              (JWT Token Verification)                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         NOTIFICATION ROUTES & CONTROLLERS                â”‚    â”‚
â”‚  â”‚                                                           â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  /api/merchant/notifications                        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ GET    /unread                                 â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ POST   /mark-multiple-read                     â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ POST   /delete-multiple                        â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ PUT    /:id/archive                            â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ POST   /clear-all                              â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ GET    /archived                               â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ POST   /test                                   â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ GET    /preferences                            â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ PUT    /preferences                            â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          MERCHANT NOTIFICATION CONTROLLER                â”‚    â”‚
â”‚  â”‚                                                           â”‚    â”‚
â”‚  â”‚  â€¢ getMerchantNotifications()                            â”‚    â”‚
â”‚  â”‚  â€¢ getUnreadNotifications()                              â”‚    â”‚
â”‚  â”‚  â€¢ markMultipleAsRead()                                  â”‚    â”‚
â”‚  â”‚  â€¢ deleteMultipleNotifications()                         â”‚    â”‚
â”‚  â”‚  â€¢ archiveNotification()                                 â”‚    â”‚
â”‚  â”‚  â€¢ clearAllNotifications()                               â”‚    â”‚
â”‚  â”‚  â€¢ getArchivedNotifications()                            â”‚    â”‚
â”‚  â”‚  â€¢ sendTestNotification()                                â”‚    â”‚
â”‚  â”‚  â€¢ getNotificationPreferences()                          â”‚    â”‚
â”‚  â”‚  â€¢ updateNotificationPreferences()                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                   â”‚                         â”‚
â”‚                     â”‚                   â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                         â”‚
â”‚  â”‚    MongoDB Database              â”‚   â”‚                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  Notification Collection   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ _id                  â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ user                 â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ title                â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ message              â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ type                 â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ category             â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ priority             â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ isRead               â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ readAt               â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ isArchived           â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ archivedAt           â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ deletedAt  â­NEW     â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ createdAt            â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ updatedAt            â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ data                 â”‚   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â”‚                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚                         â”‚
â”‚  â”‚                                  â”‚   â”‚                         â”‚
â”‚  â”‚  Indexes:                        â”‚   â”‚                         â”‚
â”‚  â”‚  â€¢ { user: 1 }                   â”‚   â”‚                         â”‚
â”‚  â”‚  â€¢ { isRead: 1 }                 â”‚   â”‚                         â”‚
â”‚  â”‚  â€¢ { isArchived: 1 }             â”‚   â”‚                         â”‚
â”‚  â”‚  â€¢ { deletedAt: 1 }  â­NEW       â”‚   â”‚                         â”‚
â”‚  â”‚  â€¢ { user, isRead, isArchived,   â”‚   â”‚                         â”‚
â”‚  â”‚     deletedAt, createdAt }       â”‚   â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                         â”‚
â”‚                                          â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Socket.IO Server                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Socket Rooms (User-specific)                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ user-{userId1}                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ user-{userId2}                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ user-{userId3}                                     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Real-time Events:                                          â”‚   â”‚
â”‚  â”‚  â€¢ notification:new                                         â”‚   â”‚
â”‚  â”‚  â€¢ notification:archived                                    â”‚   â”‚
â”‚  â”‚  â€¢ notifications:bulk-read                                  â”‚   â”‚
â”‚  â”‚  â€¢ notifications:bulk-deleted                               â”‚   â”‚
â”‚  â”‚  â€¢ notifications:cleared                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Diagrams

### 1. Get Unread Notifications Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚                 â”‚ Server â”‚                 â”‚ MongoDB  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                          â”‚                           â”‚
    â”‚ GET /unread              â”‚                           â”‚
    â”‚ + JWT Token              â”‚                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ Verify JWT                â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ Query:                    â”‚
    â”‚                          â”‚ { user: userId,           â”‚
    â”‚                          â”‚   isRead: false,          â”‚
    â”‚                          â”‚   isArchived: false,      â”‚
    â”‚                          â”‚   deletedAt: {$exists:    â”‚
    â”‚                          â”‚     false} }               â”‚
    â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚   Notifications (max 50)  â”‚
    â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                          â”‚                           â”‚
    â”‚  Response:               â”‚                           â”‚
    â”‚  {notifications, count}  â”‚                           â”‚
    â”‚  Header: X-Unread-Count  â”‚                           â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
    â”‚                          â”‚                           â”‚
```

---

### 2. Mark Multiple as Read Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Server â”‚     â”‚ MongoDB  â”‚     â”‚Socket.IO â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚               â”‚                â”‚
    â”‚ POST /mark-  â”‚               â”‚                â”‚
    â”‚ multiple-readâ”‚               â”‚                â”‚
    â”‚ {notificati- â”‚               â”‚                â”‚
    â”‚  onIds: []}  â”‚               â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚ Validate IDs  â”‚                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚ updateMany({  â”‚                â”‚
    â”‚              â”‚  _id: {$in},  â”‚                â”‚
    â”‚              â”‚  user: userId,â”‚                â”‚
    â”‚              â”‚  isRead: falseâ”‚                â”‚
    â”‚              â”‚ })            â”‚                â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚  Updated countâ”‚                â”‚
    â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚ Get unread    â”‚                â”‚
    â”‚              â”‚ count         â”‚                â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
    â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚ Emit event:   â”‚                â”‚
    â”‚              â”‚ 'notificationsâ”‚                â”‚
    â”‚              â”‚ :bulk-read'   â”‚                â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚              â”‚               â”‚     Broadcast  â”‚
    â”‚              â”‚               â”‚     to room    â”‚
    â”‚              â”‚               â”‚     user-{id}  â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚  Response    â”‚               â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚                â”‚
    â”‚              â”‚               â”‚                â”‚
    â”‚  Socket eventâ”‚               â”‚                â”‚
    â”‚  received    â”‚               â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚              â”‚               â”‚                â”‚
```

---

### 3. Soft Delete Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚                 â”‚ Server â”‚                 â”‚ MongoDB  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                          â”‚                           â”‚
    â”‚ POST /delete-multiple    â”‚                           â”‚
    â”‚ {notificationIds: []}    â”‚                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ updateMany({             â”‚
    â”‚                          â”‚   _id: {$in: ids},       â”‚
    â”‚                          â”‚   user: userId            â”‚
    â”‚                          â”‚ }, {                      â”‚
    â”‚                          â”‚   $set: {                 â”‚
    â”‚                          â”‚     deletedAt: Date.now()â”‚
    â”‚                          â”‚   }                       â”‚
    â”‚                          â”‚ })                        â”‚
    â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚   Modified count          â”‚
    â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                          â”‚                           â”‚
    â”‚  Response:               â”‚                           â”‚
    â”‚  {deleted: count}        â”‚                           â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
    â”‚                          â”‚                           â”‚
    â”‚  Note: Items still in DB â”‚                           â”‚
    â”‚  but marked as deleted   â”‚                           â”‚
    â”‚                          â”‚                           â”‚
```

---

## Data Model Schema

```typescript
interface INotification {
  _id: ObjectId;
  user: ObjectId;                    // Reference to User
  title: string;                     // Max 100 chars
  message: string;                   // Max 500 chars
  type: 'info' | 'success' | 'warning' | 'error' | 'promotional';
  category: 'order' | 'earning' | 'general' | 'promotional' |
            'social' | 'security' | 'system' | 'reminder';
  priority: 'low' | 'medium' | 'high' | 'urgent';

  // Read status
  isRead: boolean;                   // Default: false
  readAt?: Date;

  // Archive status
  isArchived: boolean;               // Default: false
  archivedAt?: Date;

  // Soft delete â­NEW
  deletedAt?: Date;                  // Null = not deleted

  // Delivery
  deliveryChannels: ('push' | 'email' | 'sms' | 'in_app')[];
  deliveryStatus: IDeliveryStatus;

  // Metadata
  data?: INotificationData;
  pushSettings?: IPushNotificationSettings;

  // Timestamps
  createdAt: Date;
  updatedAt: Date;
  expiresAt?: Date;
  scheduledAt?: Date;
  sentAt?: Date;

  // Batch & Campaign
  batchId?: string;
  campaignId?: string;
  segmentId?: string;
  source: 'system' | 'admin' | 'automated' | 'campaign';
  createdBy?: ObjectId;
  template?: string;
  variables?: Map<string, any>;
}
```

---

## Socket.IO Event Payloads

### notification:new
```typescript
{
  notification: INotification,
  timestamp: Date
}
```

### notifications:bulk-read
```typescript
{
  notificationIds: string[],
  updated: number,
  unreadCount: number,
  timestamp: Date
}
```

### notifications:bulk-deleted
```typescript
{
  notificationIds: string[],
  deleted: number,
  timestamp: Date
}
```

### notifications:cleared
```typescript
{
  cleared: number,
  onlyRead: boolean,
  timestamp: Date
}
```

### notification:archived
```typescript
{
  notificationId: string,
  timestamp: Date
}
```

---

## Query Patterns

### Get Unread (Excluding Soft-Deleted)
```javascript
{
  user: userId,
  isRead: false,
  isArchived: false,
  deletedAt: { $exists: false }  // â­ Excludes soft-deleted
}
```

### Get Archived
```javascript
{
  user: userId,
  isArchived: true
}
```

### Soft Delete
```javascript
updateMany(
  { _id: { $in: ids }, user: userId },
  { $set: { deletedAt: new Date() } }
)
```

### Mark as Read
```javascript
updateMany(
  {
    _id: { $in: ids },
    user: userId,
    isRead: false,
    deletedAt: { $exists: false }
  },
  {
    $set: {
      isRead: true,
      readAt: new Date()
    }
  }
)
```

---

## Index Strategy

```javascript
// Single field indexes
db.notifications.createIndex({ user: 1 });
db.notifications.createIndex({ isRead: 1 });
db.notifications.createIndex({ isArchived: 1 });
db.notifications.createIndex({ deletedAt: 1 });     // â­ NEW
db.notifications.createIndex({ createdAt: -1 });

// Compound indexes for common queries
db.notifications.createIndex({
  user: 1,
  isRead: 1,
  isArchived: 1,
  deletedAt: 1,     // â­ NEW
  createdAt: -1
});
```

---

## Error Handling Flow

```
Request
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authentication   â”‚â”€â”€â”€> 401 Unauthorized
â”‚ Middleware       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validation       â”‚â”€â”€â”€> 400 Bad Request
â”‚ Middleware       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller       â”‚â”€â”€â”€> 500 Internal Error
â”‚ try/catch        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Success Response â”‚â”€â”€â”€> 200 OK
â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Authentication (JWT)         â”‚
â”‚  â€¢ Verify token                        â”‚
â”‚  â€¢ Check user exists                   â”‚
â”‚  â€¢ Check account active                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Validation (Joi)             â”‚
â”‚  â€¢ Validate request body               â”‚
â”‚  â€¢ Validate query params               â”‚
â”‚  â€¢ Validate path params                â”‚
â”‚  â€¢ Type checking                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Authorization                â”‚
â”‚  â€¢ Filter by user ID                   â”‚
â”‚  â€¢ Only access own notifications       â”‚
â”‚  â€¢ Prevent cross-user access           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Soft Delete                  â”‚
â”‚  â€¢ Never hard delete                   â”‚
â”‚  â€¢ Recoverable                         â”‚
â”‚  â€¢ Audit trail                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Performance Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Level                         â”‚
â”‚  â€¢ Compound indexes                     â”‚
â”‚  â€¢ Lean queries (no Mongoose overhead)  â”‚
â”‚  â€¢ Projection (select specific fields)  â”‚
â”‚  â€¢ Pagination (limit results)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Level                      â”‚
â”‚  â€¢ Bulk operations                      â”‚
â”‚  â€¢ Async/await patterns                 â”‚
â”‚  â€¢ Error boundaries                     â”‚
â”‚  â€¢ Connection pooling                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Real-time Level                        â”‚
â”‚  â€¢ User-specific rooms                  â”‚
â”‚  â€¢ Targeted events                      â”‚
â”‚  â€¢ No global broadcast                  â”‚
â”‚  â€¢ Error handling in emit               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure

```
user-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ socket.ts                    â­ NEW
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ notificationController.ts    âœï¸ UPDATED
â”‚   â”‚   â””â”€â”€ merchantNotificationController.ts  â­ NEW
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ Notification.ts              âœï¸ UPDATED
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ notificationRoutes.ts
â”‚   â”‚   â””â”€â”€ merchant/
â”‚   â”‚       â””â”€â”€ notifications.ts         â­ NEW
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ socket.ts                    âœï¸ UPDATED
â”‚   â””â”€â”€ server.ts                        âœï¸ TO UPDATE
â””â”€â”€ Documentation/
    â”œâ”€â”€ AGENT_6_NOTIFICATION_ENDPOINTS_REPORT.md  â­ NEW
    â”œâ”€â”€ AGENT_6_QUICK_REFERENCE.md                â­ NEW
    â””â”€â”€ AGENT_6_ARCHITECTURE_DIAGRAM.md           â­ NEW
```

---

**Legend:**
- â­ NEW: Newly created
- âœï¸ UPDATED: Modified existing file
- ğŸ“„ DOCUMENT: Documentation file
